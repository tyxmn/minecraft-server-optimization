## Инструкция по оптимизации minecraft сервера

Эта инструкция поможет вам максимально оптимизировать minecraft сервер и устранить лаги. После того как вы прочитаете всё до конца и сделаете всё то, что было рекомендовано мною - ваш сервер в 99% случаев будет работать намного лучше и производительнее.

## Как обнаружить проблему
Нормальные показатели TPS это 19.8-20.0, здесь держаться большинство серверов. Если вы заметили, что всё начинает подлагивать, пропишите ```/tps``` и убедитесь, действительно ли сервер лагает. Также, консоль может выдавать предупреждение: Can't keep up! Is the server overloaded? Если это происходит, не ждите, а сразу приступайте к действиям.

## Тайминги
Если у вас низкий TPS, пропишите такие команды: ```/timings on```, подождите несколько часов, ```/timings paste```. После этого вы получите ссылку и попадёте на сайт, где сможете посмотреть, что нагружает сервер. Пролистав чуть ниже, вы увидите таблицу, где сможете определить, из-за чего опускается TPS. Если самому ничего не понятно и причины лагов не удаётся определить - напишите в какой-нибудь форум, вам обязательно помогут.

## Оперативная память

Для комфортной игры в 40 человек, вам понадобится 6 ГБ. Я рекомендую поставить [флаги Айкара](https://aikar.co/2018/07/02/tuning-the-jvm-g1gc-garbage-collector-flags-for-minecraft/), которые уменьшают потребление оперативной памяти. Помимо этих флагов, нужно поставить [этот плагин](https://www.spigotmc.org/resources/garbage-collector.26902/).

```
04 Гб ОЗУ, 2 ядра: до 25 игроков, 20 плагинов.
06 Гб ОЗУ, 3 ядра: до 40 игроков, 30 плагинов.
08 Гб ОЗУ, 4 ядра: до 60 игроков, 45 плагинов.
12 Гб ОЗУ, 5 ядер: до 80 игроков, 50 плагинов.
```

## Плагины

Никогда не ставьте плагины, которые заявляют, что они оптимизируют ваш сервер или плагины, которые изменяют генерацию мира. ClearLagg и ему подобные создают вопиющие лаги, а от EpicWorldGenerator можно ожидать проблем с нагрузкой процессора. Про платный React даже упоминать не буду, это просто позор. Измерять нагрузку этого плагина нужно не в процентах, а в ядрах. Также, стоит опасаться LockLogin, CoreProtect, высоких значений обновлений плейсхолдеров (ставьте на 60-100 тиков), нескольких плагинов на чат.

Ссылки на плагины, которые действительно оптимизируют сервер: [ServerBooster](https://www.spigotmc.org/resources/%E2%9C%85must-have%E2%9C%85-serverbooster-%E2%9A%A1optimize-your-server-anti-lag-fps-boost-multilanguage%E2%9A%A1.72184/), [Chunky (прогрузка карты)](https://www.spigotmc.org/resources/chunky.81534/), [MFM](https://www.spigotmc.org/resources/mob-farm-manager-supports-1-7-10-up-to-1-17-hopper-support.15127/).

Плагины, автоматически сохраняющие мир - сносите. Multiverse Core замените на Bungecord - систему, которая позволяет связывать несколько серверов между собой. Также, скачивать плагины можно только с этих сайтов: [spigotmc.org](https://www.spigotmc.org/), [dev.bukkit.org](https://dev.bukkit.org/). Попали на BlackSpigot? Срочно выходите с этого проклятого места. Ничего хорошего оттуда вы точно не скачаете.

![Screenshot_351](https://user-images.githubusercontent.com/74359983/123166286-eac96600-d47d-11eb-99a3-0ee7f00e96f2.png)

Касаемо сборок серверов - к ним я отношусь негативно. Лучше не поленитесь и создайте собственную сборку, потому что в ней вы будете разбираться намного лучше, чем в той, который собрал кто-то другой. В сборках частенько присутствуют вирусы. Чтобы посмотреть, есть ли вирусы в вашей сборке, скачайте [это ядро, которое нужно закинуть в папку plugins](https://www.spigotmc.org/resources/spigot-anti-malware-detects-over-300-malicious-plugins.64982/). Он распознаёт вирусы во всех .jar файлах. 

Советую не засорять свой сервер изрядным количеством плагинов. Чем больше плагинов - тем больше нагрузка на сервер. Добавьте столько плагинов, чтобы вашим игрокам было приятно играть на сервере. Согласитесь, когда вы видите перед собою текст в боссбаре, скорборде, в автоматических сообщениях в чате, а уж тем более надписи на весь экран, желание уйти с этого говна возрастает до 100%. Поверьте, если вы уберёте всю ненужную для обычного игрока информацию, ему будет намного приятнее играть. Администрационные плагины, которые используются раз в никогда - снести, различные дополнения, которыми мало кто будет пользоваться - снести, ненужные плагины просто удаляйте.

## Ядро
Рекомендую использовать [Airplane](https://github.com/TECHNOVE/Airplane) для 1.16-1.17.х. Для 1.12 и ниже - Spigot. **Не используйте** [Bukkit](https://getbukkit.org/), [Spigot](https://getbukkit.org/), [Paper](https://papermc.io/downloads), [Yatopia](https://github.com/YatopiaMC), [Sugarcane](https://github.com/SugarcaneMC/Sugarcane) для новых версий, так как это пережитки прошлого, которые имеют много проблем (конечно, если вы умеете делать патчи, вперёд, используйте Spigot и оптимизируйте ваш сервер). В Paper исправлено много багов и сделано много патчей, с производительностью есть некоторые проблемы. Tuinity и Purpur тоже неплохие, можете использовать эти ядра.

## Конфиги

### server.properties

**view-distance** - дистанция прогрузки чанков. Если на сервере много игроков и лаги происходят из-за чанков - снижайте этот параметр до 4-5 чанков. 6 чанков вполне достаточно для ванильного выживания.

````java
view-distance: 6
````

### bukkit.yml
**spawn-limits** - параметр, который отвечает за изменение количества мобов на одного игрока. Эти ограничения применяются только к животным или монстрам в загруженных чанках. Если вам не нужны летучие мыши - ambient ставьте на 0.

````java
monsters: 25, animals: 8, water-animals: 2, water-ambient: 1, ambient: 1
````

**period-in-ticks** - чем меньше, тем быстрее сервер будет выгружать пустые чанки. Если на вашем сервере играет больше 60 человек, желательно опустить этот параметр до 350.

````java
period-in-ticks: 400
````

**autosave** - если у сервера стоит HDD накопитель, вам придётся страдать от лагов из-за автоматического сохранения. Вы должны иметь SSD накопитель для нормальной работы сервера. Поднимите значение до 12000 для комфортной игры. Кстати, если у вас стоит плагин на автосохранение мира - удалите его, используйте этот параметр, он ничем не хуже.

````java
autosave: 12000
````

### spigot.yml
**save-user-cache-on-stop-only** - этот параметр отключает постоянное сохранение пользовательских данных. Если ваш сервер аварийно выключиться, пользовательские данные не будут сохранены. Желательно перезагружать свой сервер раз в 48-72 часа, чтобы предотвратить потери. **Изменяйте этот параметр на свой страх и риск!**

````java
save-user-cache-on-stop-only: true
````

**entity-activation-range** - это группа параметров, которая регулирует, насколько близко животные и мобы должны находиться к вам, чтобы активировать свой ИИ. Числа обозначают расстояние в блоках. Если вы выйдите из "зоны активации ИИ" - мобы не будут двигаться, подойдёте обратно - включат свой ИИ. Вот так это всё и работает.

````java
animals: 16
monsters: 24
raiders: 48
misc: 8
````

**mob-spawn-range** - этот параметр регулирует радиус спавна мобов возле вас. Значение должно быть на единицу меньше от кол-ва чанков, которое вы выставили.

````java
mob-spawn-range: 5
````

### Paper.yml

**max-auto-save-chunks-per-tick** - параметр замедляет частоту сохранения чанков. Не опускайте значение ниже 12, иначе некоторые чанки могут не сохраниться вообще.

````java
max-auto-save-chunks-per-tick: 12
````

**mob-spawner-tick-rate** - тики моба, вызванного спавнером. **Не поднимайте значение выше.**

````java
mob-spawner-tick-rate: 2
````

**prevent-moving-into-unloaded-chunks** - если игрок каким-то образом попал в незагруженный чанк - он постоянно будет проваливаться вниз (в пустоту), а когда сервер прогрузит чанки, он может с ним сыграть в злую шутку, не телепортировав игрока обратно. Игрок может просто умереть в пустоте. Чтобы такого не произошло, нужно включить данный параметр.

````java
prevent-moving-into-unloaded-chunks: true
````

**armor-stands-tick** - выключив данный параметр, сервер не будет проверять стенды для брони.

````java
armor-stands-tick: false
````

## Прогрузка карты

Чтобы не засорять свой диск слишком быстро, вы можете прогрузить свою карту с помощью плагина [Chunky](https://www.spigotmc.org/resources/chunky.81534/). Он абсолютно бесплатный. После того как вы добавите плагин в папку plugins, перезагрузите сервер и объявите технические работы на несколько часов своим игрокам. Станьте на нулевые координаты карты и введите эти команды поочерёдно: `/chunky center`, `/chunky radius 6000`, `/chunky start`. Готово! Теперь вам нужно подождать от одного до 8-и часов, пока плагин прогрузит 6000 блоков, которые мы задали во второй команде. Желательно ограничить свой мир до 6000 блоков. Поверьте, такого количества блоков будет вполне достаточно, чтобы всем было приятно играть. Если всё же нужно увеличить размер карты до более высоких значений - вместо 6000 напишите своё число.

После прогрузки карты нужно перезапустить сервер. Нагрузка на процессор снизится, а потребление ОЗУ от карты теперь полностью исчезло.

## Античит

Практически каждый плагин-античит убогий и потребляет слишком много ресурсов, но [Vulkan](https://www.spigotmc.org/resources/vulcan-advanced-cheat-detection-1-7-1-16-5.83626/) совсем не такой. Это лучший античит по моему мнению, производительный и мощный, который делает "ошибки" **очень редко.**
